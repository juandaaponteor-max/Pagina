<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agenda de Visas - ECCI (Estático)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --ecci-blue:#003788;
            --bg:#f7f9fc;
            --card:#ffffff;
            --muted:#6b7280;
            --radius:14px;
        }
        body{
            margin:0;
            padding:32px;
            background:var(--bg);
            font-family:"Inter",sans-serif;
            color:#0f172a;
            display:flex;
            justify-content:center;
        }
        .container{
            max-width:1100px;
            width:100%;
            display:grid;
            grid-template-columns:1fr 380px;
            gap:24px;
        }
        @media(max-width:900px){
            .container{ grid-template-columns:1fr }
        }
        .card{
            background:var(--card);
            border-radius:var(--radius);
            padding:22px;
            box-shadow:0 8px 28px rgba(0,0,0,0.06);
        }
        .header{ grid-column:1 / -1; }
        .header h1{ margin:0; color:var(--ecci-blue);}
        .header p{ margin:0; font-size:14px; color:var(--muted); }
        input, select, textarea{
            width:100%;
            padding:10px 12px;
            border-radius:10px;
            border:1px solid #cfd6e4;
            font-size:15px;
            box-sizing:border-box;
        }
        .row{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:12px;
        }
        @media(max-width:600px){
            .row{ grid-template-columns:1fr }
        }
        .btn{
            padding:10px 14px;
            border-radius:10px;
            cursor:pointer;
            border:none;
            font-weight:600;
        }
        .btn.primary{ background:var(--ecci-blue); color:white; }
        .btn.ghost{ background:white; border:1px solid #ddd; }
        .appointment{
            border:1px solid #e3e6ef;
            padding:12px;
            border-radius:12px;
            margin-bottom:10px;
        }
        .msg-alert{
            padding:10px;
            border-radius:8px;
            font-weight:600;
            margin-bottom:10px;
        }
        .msg-success{
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .hidden { display: none; }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>Agenda de Visas – ECCI</h1>
        <p>Gestión de citas y movilidad internacional (Versión Estática)</p>
    </div>
    
    <section class="card">
        <h2 style="color:var(--ecci-blue); margin-top:0">Agendar Cita</h2>

        <div id="success-message" class="msg-alert msg-success hidden">
            ✔ Cita guardada correctamente.
        </div>

        <form id="appointment-form">
            <div class="row">
                <div>
                    <label>Nombre completo *</label>
                    <input name="fullName" required>
                </div>
                <div>
                    <label>Correo *</label>
                    <input type="email" name="email" required>
                </div>
            </div>

            <div class="row" style="margin-top:12px">
                <div>
                    <label>Teléfono / WhatsApp *</label>
                    <input name="phone" required>
                </div>
                <div>
                    <label>Pasaporte *</label>
                    <input name="passport" required>
                </div>
            </div>

            <div style="margin-top:12px">
                <label>Tipo de Visa *</label>
                <select name="visaType" required>
                    <option value="">Seleccione</option>
                    <option>Turismo (B1/B2)</option>
                    <option>Estudios (F1)</option>
                    <option>Trabajo (H1B)</option>
                    <option>Intercambio (J1)</option>
                    <option>Otro</option>
                </select>
            </div>

            <div class="row" style="margin-top:12px">
                <div>
                    <label>Fecha *</label>
                    <input type="date" name="date" required>
                </div>
                <div>
                    <label>Hora *</label>
                    <input type="time" name="time" required>
                </div>
            </div>

            <div style="margin-top:12px">
                <label>Notas</label>
                <textarea name="notes" rows="3"></textarea>
            </div>

            <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn primary" type="submit">Guardar</button>
                <button class="btn ghost" type="reset">Limpiar</button>
            </div>
        </form>
    </section>

    <aside class="card">
        <h2 style="color:var(--ecci-blue); margin-top:0">Citas Guardadas</h2>

        <input id="search" placeholder="Buscar por Nombre o Pasaporte..." style="margin-bottom:10px">

        <div id="list">
            </div>

        <div style="display:flex; gap:10px; margin-top:12px">
            <button id="export-csv-btn" class="btn ghost">Exportar CSV</button>
        </div>
    </aside>
</div>

<script>
    const STORAGE_KEY = 'visaAppointments';
    const form = document.getElementById('appointment-form');
    const searchInput = document.getElementById('search');
    const appointmentList = document.getElementById('list');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const successMessage = document.getElementById('success-message');

    // 1. Cargar datos del LocalStorage
    function loadAppointments() {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
    }

    // 2. Guardar datos en el LocalStorage
    function saveAppointments(appointments) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appointments));
    }

    // 3. Renderizar la lista de citas en el DOM
    function renderAppointments(appointments) {
        appointmentList.innerHTML = ''; 

        if (appointments.length === 0) {
            appointmentList.innerHTML = '<p style="color:#888">No hay citas registradas.</p>';
            return;
        }

        appointments.forEach(c => {
            const div = document.createElement('div');
            div.className = 'appointment';
            div.innerHTML = `
                <strong>${c.fullName}</strong> - Pasaporte: ${c.passport}<br>
                <span>${c.visaType} – ${c.date} ${c.time}</span><br>
                <span style="font-size:14px; color:var(--muted)">${c.email}</span>
            `;
            appointmentList.appendChild(div);
        });
    }

    // 4. Manejar el envío del formulario (Guardar Cita)
    form.addEventListener('submit', function(event) {
        event.preventDefault(); 
        
        const formData = new FormData(form);
        const newAppointment = {};
        for (const [key, value] of formData.entries()) {
            newAppointment[key] = value;
        }

        const appointments = loadAppointments();
        appointments.push(newAppointment);
        saveAppointments(appointments);

        // Actualiza la lista y limpia el formulario
        renderAppointments(appointments);
        form.reset(); 
        
        // Muestra la notificación (REQ-F-003)
        successMessage.classList.remove('hidden');
        setTimeout(() => successMessage.classList.add('hidden'), 3000);
    });

    // 5. Manejar la Búsqueda (REQ-F-006)
    searchInput.addEventListener('input', function() {
        const query = searchInput.value.toLowerCase();
        document.querySelectorAll(".appointment").forEach(div => {
            // Busca en el texto de cada cita (nombre y pasaporte)
            const matches = div.innerText.toLowerCase().includes(query);
            div.style.display = matches ? "" : "none";
        });
    });

    // 6. Manejar la Exportación CSV (REQ-F-007)
    exportCsvBtn.addEventListener('click', function() {
        const appointments = loadAppointments();

        if (appointments.length === 0) {
            alert("No hay datos para exportar.");
            return;
        }

        // Encabezados
        let csv = "Nombre,Correo,Teléfono,Pasaporte,Tipo de Visa,Fecha,Hora,Notas\n";

        // Datos
        appointments.forEach(c => {
            // Reemplaza comas en el texto con ';' para no romper el formato CSV
            const row = [
                c.fullName, 
                c.email, 
                c.phone, 
                c.passport, 
                c.visaType, 
                c.date, 
                c.time, 
                (c.notes || "").replace(/,/g, ';')
            ];
            csv += row.join(',') + "\n";
        });

        // Crear enlace de descarga
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "citas_exportadas.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert('Tu navegador no soporta la descarga automática de archivos CSV.');
        }
    });

    // Carga inicial al iniciar la página
    document.addEventListener('DOMContentLoaded', () => {
        const initialAppointments = loadAppointments();
        renderAppointments(initialAppointments);
    });

    // Implementar REQ-F-004: Limpiar Formulario (ya resuelto con type="reset" y form.reset() en JS)
</script>
</body>
</html>
